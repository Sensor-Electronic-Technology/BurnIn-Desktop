@using BurnInControl.Data.BurnInTests.Wafers
@using BurnInControl.Data.StationModel.Components
@using BurnInControl.Infrastructure.QuickTest
@using BurnInControl.Infrastructure.TestLogs
@using BurnInControl.UI.Data
@using QuickTest.Data.DataTransfer
@using BurnInControl.UI.Components.BurnInComponents.Controls
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject QuickTestDataService QuickTestDataService
@inject TestLogDataService TestLogDataService
@rendermode InteractiveServer

<RadzenSplitter Orientation="Orientation.Horizontal">
    <RadzenSplitterPane Size="40%">
        <RadzenStack Orientation="Orientation.Vertical" 
                     Style="border: 1px solid #0a53be; margin: 0.3rem;">
            <RadzenDataGrid @ref="@this._waferSetupGrid"
                            TItem="WaferSetup"
                            Data="@this._waferSetups"
                            Density="Density.Compact"
                            GridLines="DataGridGridLines.Both"
                            Responsive="true"
                            ValueChanged="SelectedItemChangedHandler"
                            AllowAlternatingRows="false"
                            AllowColumnResize="true"
                            SelectionMode="DataGridSelectionMode.Single"
                            AllowRowSelectOnRowClick="true"
                            Value="@this._selectedItems"
                            EditMode="DataGridEditMode.Single"
                            Style="height: fit-content">
                <Columns>
                    <RadzenDataGridColumn Property="WaferId" Title="WaferId" Width="225px">
                        <EditTemplate Context="waferSetup">
                            <WaferIdInput WaferId="@waferSetup.WaferId"
                                          WaferIdChanged="@((id) => { waferSetup.WaferId = id; StateHasChanged(); })"
                                          WaferList="@this._waferList"/>
                        </EditTemplate>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn Property="BurnNumber" Title="Burn Number">
                        <EditTemplate Context="waferSetup">
                            <RadzenNumeric TValue="int" Min="1" Max="10"
                                           @bind-Value="@waferSetup.BurnNumber"/>
                        </EditTemplate>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn Property="Probe1" Title="P1"/>
                    <RadzenDataGridColumn Property="Probe2" Title="P2"/>
                    <RadzenDataGridColumn Property="StationPocket" Title="Pocket"/>
                    <RadzenDataGridColumn Property="Loaded" Visible="false">
                        <EditTemplate Context="waferSetup">
                            <RadzenStack Orientation="Orientation.Vertical"
                                         AlignItems="AlignItems.Center" Gap="0.5rem">
                                <RadzenLabel Text="@(waferSetup.Loaded ? "Loaded" : "Not Loaded")" Component="Loaded"/>
                                <RadzenSwitch @bind-Value="@waferSetup.Loaded" Name="Loaded"/>
                            </RadzenStack>
                        </EditTemplate>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn Property="Probe1Pad" Title="P1 Pad"/>
                    <RadzenDataGridColumn Property="Probe2Pad" Title="P2 Pad"/>
                    <RadzenDataGridColumn Context="waferSetup" Visible="false" Title="Edit"
                                          Filterable="false"
                                          Sortable="false"
                                          TextAlign="TextAlign.Center"
                                          Frozen="true"
                                          FrozenPosition="FrozenColumnPosition.Right">
                        <Template Context="waferSetup">
                            <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light"
                                          Variant="Variant.Flat"
                                          Size="ButtonSize.ExtraSmall"
                                          Click="@(args => EditRow(waferSetup))"
                                          @onclick:stopPropagation="true"/>
                        </Template>
                        <EditTemplate Context="waferSetup">
                            <RadzenButton Icon="check" ButtonStyle="ButtonStyle.Success"
                                          Variant="Variant.Flat"
                                          Size="ButtonSize.Medium"
                                          Click="@((args) => SaveRow(waferSetup))"
                                          aria-label="Save"/>
                            <RadzenButton Icon="close" ButtonStyle="ButtonStyle.Light"
                                          Variant="Variant.Flat"
                                          Size="ButtonSize.Medium"
                                          class="my-1 ms-1"
                                          Click="@((args) => CancelEdit(waferSetup))"
                                          aria-label="Cancel"/>
                        </EditTemplate>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
            <RadzenStack Orientation="Orientation.Horizontal"
                         AlignItems="AlignItems.Center"
                         JustifyContent="JustifyContent.Center">
                <RadzenButton Text="Verify" Size="ButtonSize.Medium"
                              Click="@this.VerifyHandler"
                              ButtonStyle="ButtonStyle.Info" 
                              Style="width: 170px"/>
                <RadzenButton Text="Save" Size="ButtonSize.Medium"
                              Disabled="@(this._setupError)"
                              Click="@this.SaveHandler"
                              ButtonStyle="ButtonStyle.Secondary"
                              Icon="save" Style="width: 170px"/>
                <RadzenButton Text="Cancel/Clear"
                              ButtonStyle="ButtonStyle.Danger"
                              Size="ButtonSize.Medium" Icon="cancel"
                              Click="@this.Cancel"
                              IsBusy="false"
                              Shade="Shade.Default"
                              Disabled="false"/>
            </RadzenStack>
            <TestSetupStatusView SetupAlerts="@this._setupAlerts" 
                                 SetupStatusVisible="@this._setupStatusVisible"/>
        </RadzenStack>
    </RadzenSplitterPane>
    <RadzenSplitterPane Size="60%" Collapsible="true">
        <RadzenTabs @ref=@this._tabs
                    RenderMode="TabRenderMode.Client"
                    @bind-SelectedIndex="@this._selectedTab" 
                    Style="border: 1px solid #2db4dc; margin: 0.3rem;">
            <Tabs>
                @for (int i = 0; i < this._waferSetups.Count; i++) {
                    var waferSetup = this._waferSetups[i];
                    int index = i;
                    <RadzenTabsItem Text="@GetPocketLabel(index)">
                        <PocketSetup PocketCaption="@GetPocketLabel(index)"
                                     WaferSetup="@waferSetup"
                                     WaferSetupChanged="@(async Task(setup) => { waferSetup = setup; await InvokeAsync(StateHasChanged); })"
                                     WaferList="@this._waferList"/>
                    </RadzenTabsItem>
                }
            </Tabs>
        </RadzenTabs>
    </RadzenSplitterPane>
</RadzenSplitter>
@code {
    [Parameter] public EventCallback<List<WaferSetup>> Save { get; set; }
    [Parameter] public IEnumerable<Pad>? Map { get; set; } = Enumerable.Empty<Pad>();
    private RadzenDataGrid<WaferSetup> _waferSetupGrid;
    private RadzenTabs _tabs;
    private IEnumerable<string> _waferList=Enumerable.Empty<string>();
    private List<WaferSetup> _selectedItems = new List<WaferSetup>();
    private int _selectedTab = 0;
    private bool _setupStatusVisible = false;
    private bool _setupError = false;
    private List<SetupAlert> _setupAlerts = new List<SetupAlert>() {
        new SetupAlert() {
            Pocket = "Left Pocket(P1)",
            WaferIdAlert = new ItemAlert(),
            ProbePadAlert = new ItemAlert(),
        },
        new SetupAlert() {
            Pocket = "Middle Pocket(P2)",
            Okay = false,
            ProbePadAlert = new ItemAlert(),
            WaferIdAlert = new ItemAlert()
        },
        new SetupAlert() {
            Pocket = "Right Pocket(P3)",
            Okay = false,
            ProbePadAlert = new ItemAlert(),
            WaferIdAlert = new ItemAlert()
        }
    };
    private List<WaferSetup> _waferSetups = new List<WaferSetup>() {
        new WaferSetup() {
            WaferId = string.Empty,
            BurnNumber = 1,
            StationPocket = StationPocket.LeftPocket,
            Probe1 = StationProbe.Probe1,
            Probe2 = StationProbe.Probe2,
            Loaded = true
        },
        new WaferSetup() {
            WaferId = string.Empty,
            BurnNumber = 1,
            StationPocket = StationPocket.MiddlePocket,
            Probe1 = StationProbe.Probe3,
            Probe2 = StationProbe.Probe4,
            Loaded = true
        },
        new WaferSetup() {
            WaferId = string.Empty,
            BurnNumber = 1,
            StationPocket = StationPocket.RightPocket,
            Probe1 = StationProbe.Probe5,
            Probe2 = StationProbe.Probe6,
            Loaded = true
        }
    };
    
    protected override async Task OnInitializedAsync() {
        this.Map = await this.QuickTestDataService.GetWaferMap(2);
        this._waferList = await this.QuickTestDataService.GetQuickTestList(new DateTime(2024,1,1));
    }
    
    async Task EditRow(WaferSetup order) {
        await _waferSetupGrid.EditRow(order);
    }
    
    async Task SaveRow(WaferSetup waferSetup) {
        await this._waferSetupGrid.UpdateRow(waferSetup);
    }

    void CancelEdit(WaferSetup waferSetup) {
        this._waferSetupGrid.CancelEditRow(waferSetup);
    }

    private async Task VerifyHandler() {
        if (this._waferSetups.All(e => !e.Loaded)) {
            await this.DialogAlert("At least one pocket must be loaded before starting a test", "Not Loaded");
            return;
        }
        for (int i = 0; i < 3; i++) {
            var setup = this._waferSetups[i];
            if (setup.Loaded) {
                if(string.IsNullOrWhiteSpace(setup.WaferId)) {
                    ItemAlert waferIdAlert = new ItemAlert();
                    waferIdAlert.Style = AlertStyle.Danger;
                    waferIdAlert.Message = "Wafer Id is empty. Please enter a wafer id or " +
                                                   "test designation before continuing";
                    waferIdAlert.Okay = false;
                    this._setupAlerts[i].WaferIdAlert= waferIdAlert;
                    bool p1Set = !string.IsNullOrEmpty(setup.Probe1Pad);
                    bool p2Set = !string.IsNullOrEmpty(setup.Probe2Pad);
                    if(p1Set && p2Set) {
                        var probePadAlert = new ItemAlert() {
                            Style = AlertStyle.Success, 
                            Message = "Pad Selection Okay", 
                            Okay = true
                        };
                        this._setupAlerts[i].ProbePadAlert = probePadAlert;
                    } else  {
                        if (p1Set == false && p2Set == false) {
                            var probePadAlert = new ItemAlert() {
                                Style = AlertStyle.Danger,
                                Message = "Neither pad is set, please set one or both pads to continue",  
                                Okay = false
                            };
                            this._setupAlerts[i].ProbePadAlert = probePadAlert;
                        } else {
                            var probePadAlert = new ItemAlert() {
                                Style = AlertStyle.Warning,
                                Message = "One pad is not set, If this was intentional press save to continue", 
                                Okay = true
                            };
                            this._setupAlerts[i].ProbePadAlert = probePadAlert;
                        }
                    }
                    this._setupAlerts[i].Okay = false;
                    continue;
                }
                var result=await this.QuickTestDataService.QuickTestExists(setup?.WaferId);
                if (!result.IsError) {
                    this._setupAlerts[i].Okay = result.Value;
                    bool p1Set = !string.IsNullOrEmpty(setup.Probe1Pad);
                    bool p2Set = !string.IsNullOrEmpty(setup.Probe2Pad);
                    if (!result.Value) {
                        ItemAlert waferIdAlert = new ItemAlert();
                        waferIdAlert.Style = AlertStyle.Secondary;
                        waferIdAlert.Message = "Wafer not found in database!! " +
                                               "If you would like to continue anyways press save";
                        waferIdAlert.Okay = true;
                        this._setupAlerts[i].WaferIdAlert= waferIdAlert;
                    } else {
                        ItemAlert waferIdAlert = new ItemAlert();
                        waferIdAlert.Style = AlertStyle.Success;
                        waferIdAlert.Message = "Wafer Found";
                        waferIdAlert.Okay = true;
                        this._setupAlerts[i].WaferIdAlert= waferIdAlert;
                    }
                    if(p1Set && p2Set) {
                        var probePadAlert = new ItemAlert() {
                            Style = AlertStyle.Success, 
                            Message = "Pad Selection Okay", 
                            Okay = true
                        };
                        this._setupAlerts[i].ProbePadAlert = probePadAlert;
                    } else  {
                        if (p1Set == false && p2Set == false) {
                            var probePadAlert = new ItemAlert() {
                                Style = AlertStyle.Danger,
                                Message = "Neither pad is set, please set one or both pads to continue",  
                                Okay = false
                            };
                            this._setupAlerts[i].ProbePadAlert = probePadAlert;
                        } else {
                            var probePadAlert = new ItemAlert() {
                                Style = AlertStyle.Warning,
                                Message = "One pad is not set, If this was intentional press save to continue", 
                                Okay = true
                            };
                            this._setupAlerts[i].ProbePadAlert = probePadAlert;
                        }
                    }
                    this._setupAlerts[i].Okay=(this._setupAlerts[i].WaferIdAlert.Okay==true && this._setupAlerts[i].ProbePadAlert.Okay==true);
                } else {
                    ItemAlert waferIdAlert = new ItemAlert();
                    waferIdAlert.Style = AlertStyle.Danger;
                    waferIdAlert.Message = $"Error: {result.FirstError.Description}. " +
                                           $"\n check network connection";
                    waferIdAlert.Okay = false;
                    this._setupAlerts[i].WaferIdAlert= waferIdAlert;
                    this._setupAlerts[i].Okay = false;
                }
            } else {
                ItemAlert waferIdAlert = new ItemAlert();
                waferIdAlert.Style = AlertStyle.Info;
                waferIdAlert.Message = "Pocket not loaded";
                waferIdAlert.Okay = true;
                this._setupAlerts[i].WaferIdAlert= waferIdAlert;
                this._setupAlerts[i].Okay = true;
            }
            await InvokeAsync(StateHasChanged);
        }
        this._setupError = this._setupAlerts.Any(e => !e.Okay);
        this._setupStatusVisible = true;
        await InvokeAsync(StateHasChanged);
    }

    private async Task SaveHandler() {
        await this.Save.InvokeAsync(this._waferSetups);
    }
    
    private async Task Cancel() {
        this._setupStatusVisible = false;
        this._setupError = false;
        for (int i = 0; i < 3; i++) {
            this._setupAlerts[i].WaferIdAlert = new ItemAlert();
            this._setupAlerts[i].ProbePadAlert = new ItemAlert();
            this._setupAlerts[i].Okay = false;
            this._setupAlerts[i].Pocket = GetPocketLabel(i);
            this._waferSetups[i] = GenerateWaferSetup(i);
        }
        this._selectedTab = 0;
        await this._waferSetupGrid.Reload();
        await InvokeAsync(StateHasChanged);
    }
    
    private string GetPocketLabel(int index) {
        return index switch {
            0 => "Left Pocket(P1)",
            1 => "Middle Pocket(P2)",
            2 => "Right Pocket(P3)",
            _ => "Unknown"
        };
    }
    
    private WaferSetup GenerateWaferSetup(int index) {
        switch (index) {
            case 0: {
                return new WaferSetup() {
                    WaferId = string.Empty,
                    BurnNumber = 1,
                    StationPocket = StationPocket.LeftPocket,
                    Probe1 = StationProbe.Probe1,
                    Probe2 = StationProbe.Probe2,
                    Loaded = true
                };
            }
            case 1: {
                return new WaferSetup() {
                    WaferId = string.Empty,
                    BurnNumber = 1,
                    StationPocket = StationPocket.MiddlePocket,
                    Probe1 = StationProbe.Probe3,
                    Probe2 = StationProbe.Probe4,
                    Loaded = true
                };
            }
            case 2: {
                return new WaferSetup() {
                    WaferId = string.Empty,
                    BurnNumber = 1,
                    StationPocket = StationPocket.RightPocket,
                    Probe1 = StationProbe.Probe5,
                    Probe2 = StationProbe.Probe6,
                    Loaded = true
                };
            }
            default: {
                return new WaferSetup();
            }
        }
    }

    private async Task SelectedItemChangedHandler(IList<WaferSetup> obj) {
        var selected=obj[0];
        this._selectedTab=this._waferSetups.IndexOf(selected);
        Console.WriteLine($"SelectedTab: {this._selectedTab}");
    }
    
    private Task Notify(NotificationSeverity severity, string summary, string detail) {
        this.NotificationService.Notify(new NotificationMessage() {
            Severity = severity,
            Summary=summary,
            Detail=detail
        });
        return Task.CompletedTask;
    }

    private Task DialogAlert(string message,string title) {
        return this.DialogService.OpenAsync<AlertDialogView>(title,
            options:new DialogOptions() {
                CloseDialogOnEsc = true, CloseDialogOnOverlayClick = true,
                ShowTitle = false
            }, parameters: new Dictionary<string, object>() { { "Title", title }, { "Message", message } });
    }
}